<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Administrador | Charlotte</title>
    <!-- Actualizado: 11/12/2025 16:38:02 -->
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body { background: #f8fafc; margin: 0; }
        .admin-header { background: linear-gradient(135deg, #1e3a8a, #3b82f6); color: #fff; padding: 20px 0; position: sticky; top: 0; z-index: 100; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .admin-header .container { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; }
        .admin-header h1 { margin: 0; font-size: 24px; }
        .admin-header h1 i { margin-right: 10px; }
        .logout-btn { background: rgba(255,255,255,0.2); color: #fff; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s; }
        .logout-btn:hover { background: rgba(255,255,255,0.3); }
        .dashboard-container { display: grid; grid-template-columns: 280px 1fr; min-height: calc(100vh - 80px); gap: 0; }
        .sidebar { background: #fff; border-right: 1px solid #e8f0fe; padding: 0; }
        .sidebar-header { padding: 24px; border-bottom: 2px solid #e8f0fe; background: linear-gradient(135deg, #f0f9ff, #e0f2fe); text-align: center; }
        .sidebar-header img { height: 60px; width: auto; margin-bottom: 12px; }
        .sidebar-header h3 { margin: 0 0 8px 0; color: #1e3a8a; font-size: 18px; }
        .sidebar-header p { margin: 0; color: #64748b; font-size: 14px; }
        .nav-menu { padding: 0; }
        .nav-item { padding: 16px 24px; display: flex; align-items: center; gap: 12px; cursor: pointer; transition: all 0.3s; border-left: 3px solid transparent; color: #334155; }
        .nav-item:hover { background: #f8fafc; border-left-color: #3b82f6; }
        .nav-item.active { background: linear-gradient(90deg, rgba(59,130,246,0.1), transparent); border-left-color: #3b82f6; color: #1e40af; font-weight: 600; }
        .nav-item i { font-size: 18px; width: 24px; text-align: center; }
        .main-content { padding: 32px; overflow-y: auto; }
        .content-section { display: none; }
        .content-section.active { display: block; }
        .page-header { margin-bottom: 32px; }
        .page-header h2 { margin: 0 0 8px 0; color: #0a1628; font-size: 32px; }
        .page-header p { margin: 0; color: #64748b; font-size: 16px; }
        .upload-card { background: #fff; border-radius: 12px; padding: 32px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 24px; }
        .upload-card h3 { margin: 0 0 24px 0; color: #1e3a8a; font-size: 20px; display: flex; align-items: center; gap: 10px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; color: #334155; font-weight: 600; font-size: 14px; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 12px 16px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; transition: all 0.3s; font-family: inherit; box-sizing: border-box; }
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59,130,246,0.1); }
        .form-group textarea { resize: vertical; min-height: 120px; }
        .btn { padding: 12px 24px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s; font-size: 14px; display: inline-flex; align-items: center; gap: 8px; }
        .btn-primary { background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: #fff; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(59,130,246,0.4); }
        .content-list { background: #fff; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .content-list-header { padding: 20px 24px; background: linear-gradient(135deg, #f0f9ff, #e0f2fe); border-bottom: 2px solid #e2e8f0; }
        .content-list-header h4 { margin: 0; color: #1e3a8a; font-size: 18px; }
        .content-item { padding: 20px 24px; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center; transition: all 0.3s; }
        .content-item:hover { background: #f8fafc; }
        .content-item:last-child { border-bottom: none; }
        .content-info { flex: 1; }
        .content-info h5 { margin: 0 0 4px 0; color: #0a1628; font-size: 16px; }
        .content-info p { margin: 0; color: #64748b; font-size: 14px; }
        .content-actions { display: flex; gap: 8px; }
        .btn-icon { width: 36px; height: 36px; border-radius: 8px; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s; }
        .btn-delete { background: #fee2e2; color: #dc2626; }
        .btn-delete:hover { background: #fecaca; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 24px; margin-bottom: 32px; }
        .stat-card { background: #fff; padding: 24px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .stat-card:hover { transform: translateY(-2px); box-shadow: 0 4px 16px rgba(0,0,0,0.12); transition: all 0.3s; }
        .stat-card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px; }
        .stat-card-icon { width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px; }
        .stat-card-icon.blue { background: #dbeafe; color: #3b82f6; }
        .stat-card-icon.green { background: #dcfce7; color: #22c55e; }
        .stat-card-icon.purple { background: #f3e8ff; color: #a855f7; }
        .stat-card-icon.orange { background: #fed7aa; color: #f97316; }
        .stat-value { font-size: 32px; font-weight: 700; color: #0a1628; margin: 0; }
        .stat-label { color: #64748b; font-size: 14px; margin: 4px 0 0 0; }
        .mobile-menu-toggle { display: none; background: rgba(255,255,255,0.2); border: none; color: #fff; font-size: 24px; padding: 8px 12px; border-radius: 8px; cursor: pointer; }
        .alert { padding: 16px 20px; border-radius: 8px; margin-bottom: 20px; display: flex; align-items: center; gap: 12px; }
        .alert-success { background: #dcfce7; color: #166534; border-left: 4px solid #22c55e; }
        .alert-info { background: #dbeafe; color: #1e40af; border-left: 4px solid #3b82f6; }
        .alert i { font-size: 20px; }
        @media (max-width: 768px) {
            .dashboard-container { grid-template-columns: 1fr; }
            .sidebar { position: fixed; left: -100%; top: 60px; width: 280px; height: calc(100vh - 60px); z-index: 99; transition: left 0.3s ease; box-shadow: 2px 0 8px rgba(0,0,0,0.1); }
            .sidebar.open { left: 0; }
            .mobile-menu-toggle { display: block; }
            .main-content { padding: 20px 16px; }
            .page-header h2 { font-size: 24px; }
            .upload-card { padding: 20px; }
            .stats-grid { grid-template-columns: 1fr; }
            .content-item { flex-direction: column; align-items: flex-start; gap: 12px; }
            .content-actions { width: 100%; justify-content: flex-end; }
        }
    </style>
</head><body>
    <header class="admin-header">
        <div class="container">
            <h1><i class="fas fa-user-shield"></i> Panel Administrador</h1>
            <button class="mobile-menu-toggle" onclick="toggleMobileMenu()"><i class="fas fa-bars"></i></button>
            <button class="logout-btn" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Cerrar Sesi√≥n</button>
        </div>
    </header>
    <div class="dashboard-container">
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='160' height='60'><rect width='100%' height='100%' fill='%23ffffff' /><text x='8' y='38' font-family='Arial, Helvetica, sans-serif' font-size='22' fill='%233b82f6'>CHARLOTTE</text></svg>" alt="Charlotte Logo">
                <h3>Admin Charlotte</h3>
                <p>Gesti√≥n de Contenidos</p>
            </div>
            <div class="nav-menu">
                <div class="nav-item active" data-section="dashboard"><i class="fas fa-chart-line"></i><span>Dashboard</span></div>
                <div class="nav-item" data-section="usuarios"><i class="fas fa-user-check"></i><span>Aprobar Usuarios</span></div>
                <div class="nav-item" data-section="calificaciones"><i class="fas fa-star"></i><span>Calificaciones</span></div>
                <div class="nav-item" data-section="videos"><i class="fas fa-video"></i><span>Subir Videos</span></div>
                <div class="nav-item" data-section="clases"><i class="fas fa-book-open"></i><span>Subir Clases</span></div>
                <div class="nav-item" data-section="actividades"><i class="fas fa-tasks"></i><span>Subir Actividades</span></div>
                <div class="nav-item" data-section="ver-entregas"><i class="fas fa-inbox"></i><span>Ver Entregas</span></div>
                <div class="nav-item" data-section="cuestionarios"><i class="fas fa-file-alt"></i><span>Subir Cuestionarios</span></div>
                <div class="nav-item" data-section="evaluaciones"><i class="fas fa-clipboard-check"></i><span>Evaluaciones</span></div>
                <div class="nav-item" data-section="materiales"><i class="fas fa-folder-open"></i><span>Subir Materiales</span></div>
            </div>
        </div>
        <div class="main-content">
            <div id="dashboard" class="content-section active">
                <div class="page-header"><h2>Dashboard</h2><p>Resumen de contenidos publicados</p></div>
                <div class="stats-grid">
                    <div class="stat-card" onclick="showSection('videos', event)" style="cursor: pointer;">
                        <div class="stat-card-header">
                            <div>
                                <h3 class="stat-value" id="stat-videos">0</h3>
                                <p class="stat-label">Videos Publicados</p>
                            </div>
                            <div class="stat-card-icon blue"><i class="fas fa-video"></i></div>
                        </div>
                    </div>
                    <div class="stat-card" onclick="showSection('clases', event)" style="cursor: pointer;">
                        <div class="stat-card-header">
                            <div>
                                <h3 class="stat-value" id="stat-clases">0</h3>
                                <p class="stat-label">Clases Subidas</p>
                            </div>
                            <div class="stat-card-icon green"><i class="fas fa-book-open"></i></div>
                        </div>
                    </div>
                    <div class="stat-card" onclick="showSection('actividades', event)" style="cursor: pointer;">
                        <div class="stat-card-header">
                            <div>
                                <h3 class="stat-value" id="stat-actividades">0</h3>
                                <p class="stat-label">Actividades Creadas</p>
                            </div>
                            <div class="stat-card-icon purple"><i class="fas fa-tasks"></i></div>
                        </div>
                    </div>
                    <div class="stat-card" onclick="showSection('materiales', event)" style="cursor: pointer;">
                        <div class="stat-card-header">
                            <div>
                                <h3 class="stat-value" id="stat-materiales">0</h3>
                                <p class="stat-label">Materiales Adicionales</p>
                            </div>
                            <div class="stat-card-icon orange"><i class="fas fa-folder-open"></i></div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="usuarios" class="content-section">
                <div class="page-header"><h2>Gesti√≥n de Usuarios</h2><p>Aprueba o rechaza solicitudes de registro</p></div>
                
                <div style="background: #fef3c7; border-left: 4px solid #f59e0b; padding: 16px; border-radius: 8px; margin-bottom: 20px;">
                    <strong><i class="fas fa-exclamation-triangle"></i> Importante sobre contrase√±as:</strong>
                    <p style="margin: 8px 0 0 0; color: #92400e;">
                        ‚Ä¢ Nuevas aprobaciones: Los estudiantes mantienen la contrase√±a que ingresaron al registrarse<br>
                        ‚Ä¢ Si un estudiante no puede ingresar: Usa el bot√≥n "Restablecer" en Usuarios Aprobados para cambiar su contrase√±a<br>
                        ‚Ä¢ Puedes ver y copiar las contrase√±as de todos los usuarios aprobados
                    </p>
                </div>
                
                <div class="content-list">
                    <div class="content-list-header"><h4>Solicitudes Pendientes</h4></div>
                    <div id="usuarios-pendientes"></div>
                </div>
                <div class="content-list" style="margin-top: 24px;">
                    <div class="content-list-header" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                        <h4>Usuarios Aprobados</h4>
                        <div style="display: flex; gap: 10px;">
                            <select id="filterPrograma" onchange="loadUsuariosAprobados()" style="padding: 8px 12px; border: 2px solid #e2e8f0; border-radius: 8px;">
                                <option value="">Todos los programas</option>
                                <option value="Panader√≠a">Panader√≠a</option>
                                <option value="Belleza">Belleza</option>
                            </select>
                            <select id="filterLugar" onchange="loadUsuariosAprobados()" style="padding: 8px 12px; border: 2px solid #e2e8f0; border-radius: 8px;">
                                <option value="">Todos los lugares</option>
                            </select>
                        </div>
                    </div>
                    <div id="usuarios-aprobados"></div>
                </div>
            </div>
            <div id="calificaciones" class="content-section">
                <div class="page-header"><h2>Gesti√≥n de Calificaciones</h2><p>Administra las calificaciones de los estudiantes</p></div>
                
                <div class="filters" style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 30px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <div style="display: flex; gap: 15px; flex-wrap: wrap; align-items: end;">
                        <div style="flex: 1; min-width: 200px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">
                                <i class="fas fa-user"></i> Estudiante
                            </label>
                            <select id="calificaciones-estudiante" onchange="loadCalificaciones()" style="width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px;">
                                <option value="">Selecciona un estudiante</option>
                            </select>
                        </div>
                        <div style="flex: 1; min-width: 200px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">
                                <i class="fas fa-book"></i> Programa
                            </label>
                            <select id="calificaciones-programa" onchange="cargarEstudiantesPorPrograma()" style="width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px;">
                                <option value="">Todos los programas</option>
                                <option value="Panader√≠a">Panader√≠a</option>
                                <option value="Belleza">Belleza</option>
                            </select>
                        </div>
                        <button onclick="resetCalificaciones()" class="btn" style="background: #64748b; color: white;">
                            <i class="fas fa-sync"></i> Limpiar
                        </button>
                    </div>
                </div>

                <div id="calificaciones-content"></div>
            </div>
            <div id="videos" class="content-section">
                <div class="page-header"><h2>Gesti√≥n de Videos</h2><p>Sube y administra videos para tus estudiantes</p></div>
                <div class="upload-card">
                    <h3><i class="fas fa-cloud-upload-alt"></i> Subir Nuevo Video</h3>
                    <form id="form-video" onsubmit="saveVideo(event)">
                        <div class="form-group"><label>T√≠tulo del Video *</label><input type="text" name="titulo" required placeholder="Ej: Introducci√≥n a la Panader√≠a"></div>
                        <div class="form-group"><label>Descripci√≥n</label><textarea name="descripcion" placeholder="Describe el contenido del video..."></textarea></div>
                        <div class="form-group"><label>URL del Video (YouTube, Vimeo, etc.) *</label><input type="url" name="url" required placeholder="https://youtube.com/watch?v=..."></div>
                        <div class="form-group"><label>Programa *</label><select name="programa" required><option value="">Selecciona un programa</option><option value="Panader√≠a">Panader√≠a y Reposter√≠a</option><option value="Belleza">Belleza y Cosmetolog√≠a</option><option value="Todos">Todos los programas</option></select></div>
                        <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Guardar Video</button>
                    </form>
                </div>
                <div class="content-list"><div class="content-list-header"><h4>Videos Publicados</h4></div><div id="videos-list"></div></div>
            </div>
            <div id="clases" class="content-section">
                <div class="page-header"><h2>Gesti√≥n de Clases</h2><p>Crea y publica material de clases</p></div>
                <div class="upload-card">
                    <h3><i class="fas fa-cloud-upload-alt"></i> Subir Nueva Clase</h3>
                    <form id="form-clase" onsubmit="saveClase(event)">
                        <div class="form-group"><label>T√≠tulo de la Clase *</label><input type="text" name="titulo" required placeholder="Ej: T√©cnicas de Amasado"></div>
                        <div class="form-group"><label>Contenido *</label><textarea name="contenido" required placeholder="Escribe el contenido de la clase..."></textarea></div>
                        <div class="form-group"><label>Programa *</label><select name="programa" required><option value="">Selecciona un programa</option><option value="Panader√≠a">Panader√≠a y Reposter√≠a</option><option value="Belleza">Belleza y Cosmetolog√≠a</option><option value="Todos">Todos los programas</option></select></div>
                        <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Guardar Clase</button>
                    </form>
                </div>
                <div class="content-list"><div class="content-list-header"><h4>Clases Publicadas</h4></div><div id="clases-list"></div></div>
            </div>
            <div id="actividades" class="content-section">
                <div class="page-header"><h2>Gesti√≥n de Actividades</h2><p>Crea actividades y tareas para los estudiantes</p></div>
                <div class="upload-card">
                    <h3><i class="fas fa-cloud-upload-alt"></i> Crear Nueva Actividad</h3>
                    <form id="form-actividad" onsubmit="saveActividad(event)">
                        <div class="form-group"><label>T√≠tulo de la Actividad *</label><input type="text" name="titulo" required placeholder="Ej: Pr√°ctica de Pan Franc√©s"></div>
                        <div class="form-group"><label>Instrucciones *</label><textarea name="instrucciones" required placeholder="Describe las instrucciones de la actividad..."></textarea></div>
                        <div class="form-group"><label>Fecha de Entrega</label><input type="date" name="fecha"></div>
                        <div class="form-group"><label>Programa *</label><select name="programa" required><option value="">Selecciona un programa</option><option value="Panader√≠a">Panader√≠a y Reposter√≠a</option><option value="Belleza">Belleza y Cosmetolog√≠a</option><option value="Todos">Todos los programas</option></select></div>
                        <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Crear Actividad</button>
                    </form>
                </div>
                <div class="content-list"><div class="content-list-header"><h4>Actividades Creadas</h4></div><div id="actividades-list"></div></div>
            </div>
            <div id="cuestionarios" class="content-section">
                <div class="page-header"><h2>Gesti√≥n de Cuestionarios</h2><p>Crea cuestionarios con preguntas de opci√≥n m√∫ltiple o abiertas</p></div>
                
                <div class="upload-card">
                    <h3><i class="fas fa-file-alt"></i> Nuevo Cuestionario</h3>
                    <form onsubmit="saveCuestionario(event)" class="upload-form" id="formCuestionario">
                        <input type="text" name="titulo" placeholder="T√≠tulo del cuestionario" required>
                        <textarea name="descripcion" placeholder="Descripci√≥n o instrucciones" rows="3"></textarea>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #0a1628;">Programa</label>
                                <select name="programa" required>
                                    <option value="">Seleccionar programa</option>
                                    <option value="Todos">Todos los programas</option>
                                    <option value="Panader√≠a">Panader√≠a</option>
                                    <option value="Belleza">Belleza</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #0a1628;">Fecha l√≠mite</label>
                                <input type="datetime-local" name="fechaLimite" required>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #0a1628;">Tiempo disponible (minutos)</label>
                                <input type="number" name="tiempoDisponible" placeholder="Ej: 30" min="1" required>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #0a1628;">Intentos permitidos</label>
                                <input type="number" name="intentos" placeholder="Ej: 1" min="1" value="1" required>
                            </div>
                        </div>
                        
                        <hr style="margin: 20px 0; border: none; border-top: 1px solid #e8f0fe;">
                        
                        <h4 style="margin-bottom: 15px; color: #e63971;"><i class="fas fa-question-circle"></i> Preguntas</h4>
                        <div id="preguntasContainer"></div>
                        
                        <button type="button" onclick="agregarPregunta()" class="btn" style="background: #10b981; margin-bottom: 15px;">
                            <i class="fas fa-plus"></i> Agregar Pregunta
                        </button>
                        
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Guardar Cuestionario
                        </button>
                    </form>
                </div>
                
                <div class="content-list">
                    <div class="content-list-header">
                        <h4>Cuestionarios Publicados</h4>
                    </div>
                    <div id="cuestionarios-list"></div>
                </div>
            </div>

            <div id="evaluaciones" class="content-section">
                <div class="page-header"><h2>Gesti√≥n de Evaluaciones</h2><p>Crea evaluaciones con preguntas aleatorias de cuestionarios</p></div>
                
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    <div>
                        <strong>¬øQu√© son las Evaluaciones?</strong>
                        <p style="margin: 4px 0 0 0; font-size: 14px;">Las evaluaciones toman preguntas aleatorias de un cuestionario base. Cada estudiante o intento recibe preguntas diferentes.</p>
                    </div>
                </div>
                
                <div class="upload-card">
                    <h3><i class="fas fa-random"></i> Crear Nueva Evaluaci√≥n</h3>
                    <p style="color: #64748b; margin-bottom: 20px;">Selecciona un cuestionario base y configura cu√°ntas preguntas aleatorias se tomar√°n por intento.</p>
                    <a href="crear-evaluacion.html" class="btn btn-primary" style="text-decoration: none;">
                        <i class="fas fa-plus-circle"></i> Crear Nueva Evaluaci√≥n
                    </a>
                </div>
                
                <div class="content-list">
                    <div class="content-list-header">
                        <h4>Evaluaciones Publicadas</h4>
                    </div>
                    <div id="evaluaciones-list"></div>
                </div>
            </div>

            <div id="materiales" class="content-section">
                <div class="page-header"><h2>Gesti√≥n de Materiales</h2><p>Sube materiales adicionales de estudio</p></div>
                
                <!-- Subir PDFs Embebidos -->
                <div class="upload-card" style="margin-bottom: 30px;">
                    <h3><i class="fas fa-file-pdf"></i> Subir Documentos PDF</h3>
                    <p style="color: #64748b; margin-bottom: 20px;">Los PDFs se mostrar√°n integrados en la p√°gina web para una mejor experiencia</p>
                    <form id="form-pdf" onsubmit="savePDF(event)">
                        <div class="form-group">
                            <label>T√≠tulo del Documento *</label>
                            <input type="text" id="pdf-titulo" required placeholder="Ej: Manual de Panader√≠a B√°sica">
                        </div>
                        <div class="form-group">
                            <label>Descripci√≥n *</label>
                            <textarea id="pdf-descripcion" required placeholder="Describe el contenido del documento..." rows="3"></textarea>
                        </div>
                        <div class="form-group">
                            <label>Programa *</label>
                            <select id="pdf-programa" required>
                                <option value="">Selecciona un programa</option>
                                <option value="Panader√≠a">Panader√≠a y Reposter√≠a</option>
                                <option value="Belleza">Belleza y Cosmetolog√≠a</option>
                                <option value="Todos">Todos los programas</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Seleccionar archivo PDF *</label>
                            <input type="file" id="pdf-file" accept=".pdf" required 
                                   style="padding: 10px; border: 2px dashed #cbd5e1; border-radius: 8px; background: #f8fafc;">
                            <small style="color: #64748b; display: block; margin-top: 8px;">
                                <i class="fas fa-info-circle"></i> Tama√±o m√°ximo recomendado: 10MB
                            </small>
                        </div>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-upload"></i> Subir PDF
                        </button>
                    </form>
                </div>

                <!-- Subir Enlaces/URLs -->
                <div class="upload-card">
                    <h3><i class="fas fa-link"></i> Agregar Enlaces y Recursos</h3>
                    <form id="form-material" onsubmit="saveMaterial(event)">
                        <div class="form-group"><label>Nombre del Material *</label><input type="text" name="titulo" required placeholder="Ej: Tabla de Equivalencias"></div>
                        <div class="form-group"><label>Descripci√≥n</label><textarea name="descripcion" placeholder="Describe el material..."></textarea></div>
                        <div class="form-group"><label>URL o Enlace *</label><input type="text" name="url" placeholder="URL del archivo o enlace" required></div>
                        <div class="form-group"><label>Programa *</label><select name="programa" required><option value="">Selecciona un programa</option><option value="Panader√≠a">Panader√≠a y Reposter√≠a</option><option value="Belleza">Belleza y Cosmetolog√≠a</option><option value="Todos">Todos los programas</option></select></div>
                        <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Guardar Material</button>
                    </form>
                </div>
                
                <!-- Recetarios Est√°ticos -->
                <div class="upload-card" style="background: linear-gradient(135deg, #f0f9ff, #e0f2fe); border: 2px solid #3b82f6;">
                    <h3><i class="fas fa-book"></i> Recetarios Disponibles</h3>
                    <p style="color: #64748b; margin-bottom: 20px;">Acceso r√°pido a los recetarios oficiales del curso</p>
                    <div class="content-item" style="background: white; border-radius: 8px; padding: 16px; margin-bottom: 12px;">
                        <div class="content-info">
                            <h5>üìñ Recetario de Panader√≠a 2024-2025</h5>
                            <p>M√°s de 40 recetas profesionales - Panes, Bizcochos, Pasteler√≠a y m√°s</p>
                        </div>
                        <a href="recetario-index.html" target="_blank" class="btn btn-primary" style="text-decoration:none;">
                            <i class="fas fa-external-link-alt"></i> Ver Recetario
                        </a>
                    </div>
                </div>

                <div class="content-list"><div class="content-list-header"><h4>Materiales Publicados</h4></div><div id="materiales-list"></div></div>
            </div>
        </div>
    </div>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
    <script>
// Delegaci√≥n de eventos para navegaci√≥n robusta
document.addEventListener('DOMContentLoaded', function() {
    document.querySelector('.nav-menu').addEventListener('click', function(e) {
        const navItem = e.target.closest('.nav-item[data-section]');
        if (navItem) {
            const section = navItem.getAttribute('data-section');
            if(section === 'ver-entregas') {
                window.location.href = 'ver-entregas.html';
            } else {
                showSection(section, e);
            }
        }
    });
    // Inicializar secci√≥n activa
    const savedSection = sessionStorage.getItem('adminActiveSection') || 'dashboard';
    showSection(savedSection);
});
const firebaseConfig = {
    apiKey: "AIzaSyCBpoxr8yhAfCVqP00b6DKtMA0JWljlMMA",
    authDomain: "charlotte-babda.firebaseapp.com",
    projectId: "charlotte-babda",
    storageBucket: "charlotte-babda.firebasestorage.app",
    messagingSenderId: "486360806502",
    appId: "1:486360806502:web:d82fb7f351b8fe4587a9a7"
};

const app = firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const currentUser = JSON.parse(sessionStorage.getItem('currentUser') || 'null');
if (!currentUser || currentUser.role !== 'admin') {
    window.location.href = 'login.html';
}

// Limpiar historial para evitar volver a login con bot√≥n atr√°s
if (window.history && window.history.pushState) {
    window.history.replaceState({page: 'admin'}, 'Panel Administrador', 'admin.html');
}

// Interceptar el bot√≥n atr√°s del navegador
window.addEventListener('popstate', function(event) {
    const activeSection = sessionStorage.getItem('adminActiveSection');
    if (activeSection && activeSection !== 'dashboard') {
        event.preventDefault();
        window.showSection('dashboard');
        window.history.pushState({page: 'admin', section: 'dashboard'}, 'Dashboard', 'admin.html');
    }
});

// Restaurar la secci√≥n activa al recargar la p√°gina
const savedAdminSection = sessionStorage.getItem('adminActiveSection');
if (savedAdminSection && savedAdminSection !== 'dashboard') {
    window.addEventListener('DOMContentLoaded', () => {
        window.showSection(savedAdminSection);
    });
} else if (!savedAdminSection) {
    sessionStorage.setItem('adminActiveSection', 'dashboard');
}

// Funci√≥n local de filtrado por programa (usa selects locales si existen)
function filterByProgram(items) {
    try {
        if (!Array.isArray(items)) return items;
        const sel = document.getElementById('filterPrograma') || document.getElementById('programFilter') || null;
        const value = sel ? (sel.value || '') : '';
        if (!value || value === 'Todos') return items;
        return items.filter(it => {
            const prog = (it.programa || it.program || it.programName || '').toString();
            return prog === value || prog.includes(value);
        });
    } catch (e) {
        console.error('filterByProgram error', e);
        return items;
    }
}

// ----- Helpers para usar el proxy backend cuando Firestore no responde -----
async function proxyGetCollection(collection) {
    try {
        const token = (JSON.parse(sessionStorage.getItem('currentUser') || '{}')).token;
        const headers = token ? { 'Authorization': 'Bearer ' + token } : {};
        const res = await fetch(`/api/firestore/${collection}`, { headers });
        if (!res.ok) {
            const text = await res.text();
            throw new Error(res.status + ' ' + (text || res.statusText));
        }
        return await res.json();
    } catch (err) {
        console.warn('proxyGetCollection fallo:', collection, err.message);
        throw err;
    }
}

async function proxyPostCollection(collection, body) {
    const adminCollections = ['videos','clases','actividades','materiales','cuestionarios','evaluaciones','pendingStudents','approvedStudents'];
    const url = adminCollections.includes(collection) ? `/api/public-admin/${collection}` : `/api/firestore/${collection}`;
    try {
        const token = (JSON.parse(sessionStorage.getItem('currentUser') || '{}')).token;
        const headers = Object.assign({ 'Content-Type': 'application/json' }, token ? { 'Authorization': 'Bearer ' + token } : {});
        const res = await fetch(url, { method: 'POST', headers, body: JSON.stringify(body) });
        if (!res.ok) {
            const json = await res.json().catch(()=>null);
            throw new Error((json && json.message) || `Error ${res.status}`);
        }
        return await res.json();
    } catch (err) {
        console.error('proxyPostCollection error:', collection, err);
        throw err;
    }
}

async function proxyDeleteCollection(collection, id) {
    const adminCollections = ['videos','clases','actividades','materiales','cuestionarios','evaluaciones'];
    const url = adminCollections.includes(collection) ? `/api/public-admin/${collection}/${id}` : `/api/firestore/${collection}/${id}`;
    try {
        const token = (JSON.parse(sessionStorage.getItem('currentUser') || '{}')).token;
        const headers = token ? { 'Authorization': 'Bearer ' + token } : {};
        const res = await fetch(url, { method: 'DELETE', headers });
        if (!res.ok) {
            const json = await res.json().catch(()=>null);
            throw new Error((json && json.message) || `Error ${res.status}`);
        }
        return await res.json();
    } catch (err) {
        console.error('proxyDeleteCollection error:', collection, id, err);
        throw err;
    }
}

async function proxyPatchCollection(collection, id, body) {
    const adminCollections = ['videos','clases','actividades','materiales','cuestionarios','evaluaciones','pendingStudents','approvedStudents'];
    const url = adminCollections.includes(collection) ? `/api/public-admin/${collection}/${id}` : `/api/firestore/${collection}/${id}`;
    try {
        const token = (JSON.parse(sessionStorage.getItem('currentUser') || '{}')).token;
        const headers = Object.assign({ 'Content-Type': 'application/json' }, token ? { 'Authorization': 'Bearer ' + token } : {});
        const res = await fetch(url, { method: 'PATCH', headers, body: JSON.stringify(body) });
        if (!res.ok) {
            const json = await res.json().catch(()=>null);
            throw new Error((json && json.message) || `Error ${res.status}`);
        }
        return await res.json();
    } catch (err) {
        console.error('proxyPatchCollection error:', collection, id, err);
        throw err;
    }
}

window.showSection = function(sectionId, event) {
    // Oculta todas las secciones
    document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
    // Quita el activo de todos los nav-item
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    // Muestra la secci√≥n seleccionada
    const section = document.getElementById(sectionId);
    if (section) section.classList.add('active');
    // Activa el nav-item correspondiente
    const navItem = document.querySelector(`.nav-item[data-section='${sectionId}']`);
    if (navItem) navItem.classList.add('active');
    // Guarda la secci√≥n actual
    sessionStorage.setItem('adminActiveSection', sectionId);
    // Responsive: cierra sidebar en m√≥vil
    if (window.innerWidth <= 768) {
        const sidebar = document.getElementById('sidebar');
        if (sidebar) sidebar.classList.remove('open');
    }
    // Historial navegador
    if (window.history && window.history.pushState) {
        window.history.pushState({page: 'admin', section: sectionId}, sectionId, 'admin.html');
    }
    loadContent(sectionId);
};

window.saveCuestionario = async function(e) {
    e.preventDefault();
    const formData = new FormData(e.target);
    // Recopilar preguntas
    const preguntas = [];
    const preguntasElements = document.querySelectorAll('.pregunta-item');
    preguntasElements.forEach((item, index) => {
        const tipo = item.querySelector('[name^="tipoPregunta"]').value;
        const textoPregunta = item.querySelector('[name^="pregunta"]').value;
        if (!textoPregunta.trim()) return;
        const pregunta = {
            id: Date.now() + index,
            texto: textoPregunta,
            tipo: tipo
        };
        if (tipo === 'multiple') {
            pregunta.opciones = [
                item.querySelector('[name^="opcion1"]').value,
                item.querySelector('[name^="opcion2"]').value,
                item.querySelector('[name^="opcion3"]').value,
                item.querySelector('[name^="opcion4"]').value
            ];
            pregunta.respuestaCorrecta = parseInt(item.querySelector('[name^="correcta"]').value);
        }
        preguntas.push(pregunta);
    });
    if (preguntas.length === 0) {
        alert('‚ö†Ô∏è Debes agregar al menos una pregunta');
        return;
    }
    const cuestionario = {
        titulo: formData.get('titulo'),
        descripcion: formData.get('descripcion'),
        programa: formData.get('programa'),
        fechaLimite: formData.get('fechaLimite'),
        tiempoDisponible: parseInt(formData.get('tiempoDisponible')),
        intentos: parseInt(formData.get('intentos')),
        preguntas: preguntas,
        fecha: new Date().toLocaleDateString(),
        fechaRegistro: new Date().toISOString()
    };
    try {
        await proxyPostCollection('cuestionarios', cuestionario);
        e.target.reset();
        document.getElementById('preguntasContainer').innerHTML = '';
        await loadCuestionarios();
        updateStats();
        showAlert('Cuestionario guardado exitosamente');
    } catch (error) {
        console.error('Error al guardar cuestionario:', error);
        alert('Error al guardar el cuestionario. Intenta nuevamente.');
    }
}

window.saveCuestionario = async function(e) {
    e.preventDefault();
    const formData = new FormData(e.target);
    // Recopilar preguntas
    const preguntas = [];
    const preguntasElements = document.querySelectorAll('.pregunta-item');
    preguntasElements.forEach((item, index) => {
        const tipo = item.querySelector('[name^="tipoPregunta"]').value;
        const textoPregunta = item.querySelector('[name^="pregunta"]').value;
        if (!textoPregunta.trim()) return;
        const pregunta = {
            id: Date.now() + index,
            texto: textoPregunta,
            tipo: tipo
        };
        if (tipo === 'multiple') {
            pregunta.opciones = [
                item.querySelector('[name^="opcion1"]').value,
                item.querySelector('[name^="opcion2"]').value,
                item.querySelector('[name^="opcion3"]').value,
                item.querySelector('[name^="opcion4"]').value
            ];
            pregunta.respuestaCorrecta = parseInt(item.querySelector('[name^="correcta"]').value);
        }
        preguntas.push(pregunta);
    });
    if (preguntas.length === 0) {
        alert('‚ö†Ô∏è Debes agregar al menos una pregunta');
        return;
    }
    const cuestionario = {
        titulo: formData.get('titulo'),
        descripcion: formData.get('descripcion'),
        programa: formData.get('programa'),
        fechaLimite: formData.get('fechaLimite'),
        tiempoDisponible: parseInt(formData.get('tiempoDisponible')),
        intentos: parseInt(formData.get('intentos')),
        preguntas: preguntas,
        fecha: new Date().toLocaleDateString(),
        fechaRegistro: new Date().toISOString()
    };
    try {
        await proxyPostCollection('cuestionarios', cuestionario);
        e.target.reset();
        document.getElementById('preguntasContainer').innerHTML = '';
        await loadCuestionarios();
        updateStats();
        showAlert('Cuestionario guardado con ' + preguntas.length + ' preguntas y sincronizado en todos los dispositivos');
    } catch (error) {
        console.error('Error al guardar cuestionario:', error);
        alert('Error al guardar el cuestionario. Intenta nuevamente.');
    }
}

let contadorPreguntas = 0;

window.agregarPregunta = function() {
    contadorPreguntas++;
    const container = document.getElementById('preguntasContainer');
    
    const preguntaHTML = `
        <div class="pregunta-item" id="pregunta${contadorPreguntas}" style="background: #f8fafc; padding: 20px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #e63971;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h5 style="margin: 0; color: #0b3460;"><i class="fas fa-question"></i> Pregunta ${contadorPreguntas}</h5>
                <button type="button" onclick="eliminarPregunta(${contadorPreguntas})" class="btn" style="background: #ef4444; padding: 5px 10px; font-size: 12px;">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
            
            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #0a1628;">Tipo de pregunta</label>
            <select name="tipoPregunta${contadorPreguntas}" onchange="toggleTipoPregunta(${contadorPreguntas})" style="margin-bottom: 15px;" required>
                <option value="multiple">Opci√≥n m√∫ltiple</option>
                <option value="abierta">Respuesta abierta</option>
            </select>
            
            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #0a1628;">Pregunta</label>
            <textarea name="pregunta${contadorPreguntas}" placeholder="Escribe tu pregunta aqu√≠" rows="2" required style="margin-bottom: 15px;"></textarea>
            
            <div id="opcionesMultiple${contadorPreguntas}">
                <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #0a1628;">Opciones de respuesta</label>
                <div style="display: grid; gap: 10px;">
                    <input type="text" name="opcion1_${contadorPreguntas}" placeholder="Opci√≥n 1" required>
                    <input type="text" name="opcion2_${contadorPreguntas}" placeholder="Opci√≥n 2" required>
                    <input type="text" name="opcion3_${contadorPreguntas}" placeholder="Opci√≥n 3" required>
                    <input type="text" name="opcion4_${contadorPreguntas}" placeholder="Opci√≥n 4" required>
                </div>
                
                <label style="display: block; margin: 15px 0 5px; font-weight: 600; color: #0a1628;">Respuesta correcta</label>
                <select name="correcta${contadorPreguntas}" required>
                    <option value="0">Opci√≥n 1</option>
                    <option value="1">Opci√≥n 2</option>
                    <option value="2">Opci√≥n 3</option>
                    <option value="3">Opci√≥n 4</option>
                </select>
            </div>
            
            <div id="respuestaAbierta${contadorPreguntas}" style="display: none;">
                <p style="color: #64748b; font-size: 14px;"><i class="fas fa-info-circle"></i> Los estudiantes podr√°n escribir su respuesta libremente</p>
            </div>
        </div>
    `;
    
    container.insertAdjacentHTML('beforeend', preguntaHTML);
}

window.eliminarPregunta = function(id) {
    document.getElementById('pregunta' + id).remove();
}

window.toggleTipoPregunta = function(id) {
    const tipo = document.querySelector(`[name="tipoPregunta${id}"]`).value;
    const opcionesDiv = document.getElementById(`opcionesMultiple${id}`);
    const abiertoDiv = document.getElementById(`respuestaAbierta${id}`);
    
    if (tipo === 'multiple') {
        opcionesDiv.style.display = 'block';
        abiertoDiv.style.display = 'none';
        opcionesDiv.querySelectorAll('input, select').forEach(input => input.required = true);
    } else {
        opcionesDiv.style.display = 'none';
        abiertoDiv.style.display = 'block';
        opcionesDiv.querySelectorAll('input, select').forEach(input => input.required = false);
    }
}

window.saveMaterial = async function(e) {
    e.preventDefault();
    const formData = new FormData(e.target);
    const material = {
        titulo: formData.get('titulo'),
        descripcion: formData.get('descripcion'),
        url: formData.get('url'),
        programa: formData.get('programa'),
        fecha: new Date().toLocaleDateString(),
        tipo: 'enlace',
        fechaCreacion: new Date().toISOString()
    };
    try {
        await proxyPostCollection('materiales', material);
        e.target.reset();
        await loadMateriales();
        updateStats();
        showAlert('Material guardado exitosamente y sincronizado en todos los dispositivos');
    } catch (error) {
        console.error('Error al guardar material:', error);
        alert('Error al guardar el material. Intenta nuevamente.');
    }
}

// Guardar nueva clase en Firestore (con fallback a localStorage)
window.saveClase = async function(e) {
    e.preventDefault();
    const formData = new FormData(e.target);
    const clase = {
        titulo: formData.get('titulo'),
        contenido: formData.get('contenido'),
        programa: formData.get('programa'),
        fecha: new Date().toLocaleDateString(),
        fechaCreacion: new Date().toISOString()
    };
    try {
        await proxyPostCollection('clases', clase);
        e.target.reset();
        await loadClases();
        updateStats();
        showAlert('Clase guardada exitosamente y sincronizada en Firestore');
    } catch (error) {
        console.error('Error al guardar clase (Firestore):', error);
        // Fallback local
        try {
            const clases = JSON.parse(localStorage.getItem('clases') || '[]');
            clase.id = Date.now();
            clases.push(clase);
            localStorage.setItem('clases', JSON.stringify(clases));
            e.target.reset();
            loadClases();
            updateStats();
            showAlert('Clase guardada localmente (Firestone inaccesible)');
        } catch (e2) {
            console.error('Fallback localStorage error:', e2);
            alert('Error al guardar la clase. Intenta nuevamente.');
        }
    }
}

// Eliminar funci√≥n deleteItem basada en localStorage (ya no se usa)

window.loadContent = function(section) {
    try {
        switch(section) {
            case 'videos': typeof loadVideos === 'function' ? loadVideos() : console.warn('Falta loadVideos'); break;
            case 'clases': typeof loadClases === 'function' ? loadClases() : console.warn('Falta loadClases'); break;
            case 'actividades': typeof loadActividades === 'function' ? loadActividades() : console.warn('Falta loadActividades'); break;
            case 'cuestionarios': typeof loadCuestionarios === 'function' ? loadCuestionarios() : console.warn('Falta loadCuestionarios'); break;
            case 'evaluaciones': typeof loadEvaluaciones === 'function' ? loadEvaluaciones() : console.warn('Falta loadEvaluaciones'); break;
            case 'materiales': typeof loadMateriales === 'function' ? loadMateriales() : console.warn('Falta loadMateriales'); break;
            case 'usuarios': typeof loadUsuarios === 'function' ? loadUsuarios() : console.warn('Falta loadUsuarios'); break;
            case 'calificaciones': typeof cargarEstudiantesPorPrograma === 'function' ? cargarEstudiantesPorPrograma() : console.warn('Falta cargarEstudiantesPorPrograma'); break;
            case 'dashboard': typeof updateStats === 'function' ? updateStats() : console.warn('Falta updateStats'); break;
        }
    } catch (err) {
        console.error('Error al cargar secci√≥n:', section, err);
    }
}

async function loadVideos() {
    const container = document.getElementById('videos-list');
    if (!container) return;
    try {
        const videos = await proxyGetCollection('videos');
        const filtered = (typeof filterByProgram === 'function') ? filterByProgram(videos) : videos;
        if (filtered.length === 0) {
            container.innerHTML = '<div class="content-item"><div class="content-info"><h5>No hay videos publicados</h5><p>Los videos que subas aparecer√°n aqu√≠</p></div></div>';
            return;
        }
        container.innerHTML = filtered.map(video => `
            <div class="content-item">
                <div class="content-info">
                    <h5>${video.titulo}</h5>
                    <p>${video.programa} ‚Ä¢ ${video.fecha} ‚Ä¢ <a href="${video.url}" target="_blank">Ver video</a></p>
                </div>
                <div class="content-actions">
                    <button class="btn-icon btn-delete" onclick="deleteVideoFirestore('${video.id}')">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `).join('');
    } catch (error) {
        console.error('Error al cargar videos:', error && error.code ? error.code : '', error && error.message ? error.message : error);
        // Fallback: intentar cargar desde localStorage si Firestore falla
        try {
            const stored = JSON.parse(localStorage.getItem('videos') || '[]');
            if (stored && stored.length) {
                container.innerHTML = stored.map(video => `
                    <div class="content-item">
                        <div class="content-info">
                            <h5>${video.titulo || video.title}</h5>
                            <p>${video.programa || ''} ‚Ä¢ ${video.fecha || ''} ‚Ä¢ <a href="${video.url}" target="_blank">Ver video</a></p>
                        </div>
                        <div class="content-actions">
                            <button class="btn-icon btn-delete" onclick="deleteVideoFirestore('${video.id || ''}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `).join('');
                showAlert('Cargando videos desde cache local (Firestore inaccesible)');
                return;
            }
        } catch (e) { console.error('Fallback localStorage error', e); }
        container.innerHTML = '<div class="content-item"><div class="content-info"><h5>Error al cargar videos</h5><p>Intenta recargar la p√°gina o verifica tus permisos.</p></div></div>';
    }
}

window.deleteVideoFirestore = async function(id) {
    if (!confirm('¬øEst√°s seguro de eliminar este video?')) return;
    try {
        await proxyDeleteCollection('videos', id);
        await loadVideos();
        updateStats();
        showAlert('Video eliminado exitosamente');
    } catch (error) {
        console.error('Error al eliminar video:', error);
        alert('Error al eliminar el video');
    }
}

async function loadClases() {
    const container = document.getElementById('clases-list');
    if (!container) return;
    try {
        const clases = await proxyGetCollection('clases');
        const filtered = filterByProgram(clases);
        if (filtered.length === 0) {
            container.innerHTML = '<div class="content-item"><div class="content-info"><h5>No hay clases publicadas</h5><p>Las clases que subas aparecer√°n aqu√≠</p></div></div>';
            return;
        }
        container.innerHTML = filtered.map(clase => `
            <div class="content-item">
                <div class="content-info">
                    <h5>${clase.titulo}</h5>
                    <p>${clase.programa} ‚Ä¢ ${clase.fecha}</p>
                </div>
                <div class="content-actions">
                    <button class="btn-icon btn-delete" onclick="deleteClaseFirestore('${clase.id}')">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `).join('');
    } catch (error) {
        console.error('Error al cargar clases:', error);
        container.innerHTML = '<div class="content-item"><div class="content-info"><h5>Error al cargar clases</h5><p>Intenta recargar la p√°gina</p></div></div>';
    }
}

window.deleteClaseFirestore = async function(id) {
    if (!confirm('¬øEst√°s seguro de eliminar esta clase?')) return;
    try {
        await proxyDeleteCollection('clases', id);
        await loadClases();
        updateStats();
        showAlert('Clase eliminada exitosamente');
    } catch (error) {
        console.error('Error al eliminar clase:', error);
        alert('Error al eliminar la clase');
    }
}

async function loadActividades() {
    const container = document.getElementById('actividades-list');
    if (!container) return;
    try {
        const actividades = await proxyGetCollection('actividades');
        const filtered = filterByProgram(actividades);
        if (filtered.length === 0) {
            container.innerHTML = '<div class="content-item"><div class="content-info"><h5>No hay actividades creadas</h5><p>Las actividades que crees aparecer√°n aqu√≠</p></div></div>';
            return;
        }
        container.innerHTML = filtered.map(actividad => `
            <div class="content-item">
                <div class="content-info">
                    <h5>${actividad.titulo}</h5>
                    <p>${actividad.programa} ‚Ä¢ Entrega: ${actividad.fecha || 'Sin fecha'} ‚Ä¢ Creada: ${actividad.fechaCreacion}</p>
                </div>
                <div class="content-actions">
                    <button class="btn-icon btn-delete" onclick="deleteActividadFirestore('${actividad.id}')">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `).join('');
    } catch (error) {
        console.error('Error al cargar actividades:', error);
        container.innerHTML = '<div class="content-item"><div class="content-info"><h5>Error al cargar actividades</h5><p>Intenta recargar la p√°gina</p></div></div>';
    }
}

window.deleteActividadFirestore = async function(id) {
    if (!confirm('¬øEst√°s seguro de eliminar esta actividad?')) return;
    try {
        await proxyDeleteCollection('actividades', id);
        await loadActividades();
        updateStats();
        showAlert('Actividad eliminada exitosamente');
    } catch (error) {
        console.error('Error al eliminar actividad:', error);
        alert('Error al eliminar la actividad');
    }
}

async function loadCuestionarios() {
    const container = document.getElementById('cuestionarios-list');
    if (!container) return;
    try {
        const cuestionarios = await proxyGetCollection('cuestionarios');
        const filtered = filterByProgram(cuestionarios);
        if (filtered.length === 0) {
            container.innerHTML = '<div class="content-item"><div class="content-info"><h5>No hay cuestionarios publicados</h5><p>Los cuestionarios que crees aparecer√°n aqu√≠</p></div></div>';
            return;
        }
        container.innerHTML = filtered.map(cuestionario => {
            const fechaLimite = cuestionario.fechaLimite ? new Date(cuestionario.fechaLimite).toLocaleString('es-ES') : 'Sin fecha l√≠mite';
            const numPreguntas = cuestionario.preguntas?.length || 0;
            const tiempo = cuestionario.tiempoDisponible ? cuestionario.tiempoDisponible + ' min' : 'Sin l√≠mite';
            return `
            <div class="content-item">
                <div class="content-info">
                    <h5>${cuestionario.titulo}</h5>
                    <p>${cuestionario.programa} ‚Ä¢ ${numPreguntas} pregunta${numPreguntas !== 1 ? 's' : ''} ‚Ä¢ ${tiempo} ‚Ä¢ ${cuestionario.intentos || 1} intento${cuestionario.intentos !== 1 ? 's' : ''}</p>
                    <p style="font-size: 13px; color: #64748b; margin-top: 4px;">${cuestionario.descripcion || ''}</p>
                    <p style="font-size: 12px; color: #e63971; margin-top: 4px;"><i class="fas fa-clock"></i> ${fechaLimite}</p>
                </div>
                <div class="content-actions">
                    <button class="btn-icon btn-delete" onclick="deleteCuestionarioFirestore('${cuestionario.id}')" title="Eliminar">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
            `;
        }).join('');
    } catch (error) {
        console.error('Error al cargar cuestionarios:', error);
        container.innerHTML = '<div class="content-item"><div class="content-info"><h5>Error al cargar cuestionarios</h5><p>Intenta recargar la p√°gina</p></div></div>';
    }
}

window.deleteCuestionarioFirestore = async function(id) {
    if (!confirm('¬øEliminar este cuestionario?')) return;
    try {
        await proxyDeleteCollection('cuestionarios', id);
        await loadCuestionarios();
        updateStats();
        showAlert('Cuestionario eliminado exitosamente');
    } catch (error) {
        console.error('Error al eliminar cuestionario:', error);
        alert('Error al eliminar el cuestionario');
    }
}

window.deleteCuestionario = function(id) {
    if (!confirm('¬øEliminar este cuestionario?')) return;
    let cuestionarios = JSON.parse(localStorage.getItem('cuestionarios') || '[]');
    cuestionarios = cuestionarios.filter(c => c.id != id);
    localStorage.setItem('cuestionarios', JSON.stringify(cuestionarios));
    loadCuestionarios();
    updateStats();
    showAlert('Cuestionario eliminado');
}

function verCuestionario(id) {
    const cuestionarios = JSON.parse(localStorage.getItem('cuestionarios') || '[]');
    const cuestionario = cuestionarios.find(c => c.id === id);
    if (cuestionario) {
        sessionStorage.setItem('cuestionarioPreview', JSON.stringify(cuestionario));
        window.open('preview-cuestionario.html', '_blank');
    }
}

function editarCuestionario(id) {
    const cuestionarios = JSON.parse(localStorage.getItem('cuestionarios') || '[]');
    const cuestionario = cuestionarios.find(c => c.id === id);
    if (cuestionario) {
        sessionStorage.setItem('cuestionarioEditar', JSON.stringify(cuestionario));
        window.location.href = 'crear-cuestionario.html?editar=' + id;
    }
}

function deleteCuestionario(id) {
    if (!confirm('¬øEst√°s seguro de eliminar este cuestionario?')) return;
    let cuestionarios = JSON.parse(localStorage.getItem('cuestionarios') || '[]');
    cuestionarios = cuestionarios.filter(c => c.id !== id);
    localStorage.setItem('cuestionarios', JSON.stringify(cuestionarios));
    loadCuestionarios();
    updateStats();
    showAlert('Cuestionario eliminado exitosamente');
}

async function loadEvaluaciones() {
    const container = document.getElementById('evaluaciones-list');
    if (!container) return;
    try {
        const evaluaciones = await proxyGetCollection('evaluaciones');
        if (evaluaciones.length === 0) {
            container.innerHTML = '<div class="content-item"><div class="content-info"><h5>No hay evaluaciones publicadas</h5><p>Las evaluaciones que crees aparecer√°n aqu√≠</p></div></div>';
            return;
        }
        container.innerHTML = evaluaciones.map(evaluacion => `
            <div class="content-item">
                <div class="content-info">
                    <h5>${evaluacion.titulo}</h5>
                    <p>${evaluacion.programa} ‚Ä¢ ${evaluacion.numPreguntas} preguntas de ${evaluacion.cuestionarioNombre} ‚Ä¢ ${evaluacion.maxIntentos} intentos</p>
                    <p style="font-size: 13px; color: #64748b; margin-top: 4px;">Desde: ${new Date(evaluacion.fechaInicio).toLocaleString()} hasta ${new Date(evaluacion.fechaFin).toLocaleString()}</p>
                </div>
                <div class="content-actions">
                    <button class="btn-icon" onclick="verEvaluacion('${evaluacion.id}')" title="Ver evaluaci√≥n">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn-icon" onclick="editarEvaluacion('${evaluacion.id}')" title="Editar">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn-icon btn-delete" onclick="deleteEvaluacionFirestore('${evaluacion.id}')" title="Eliminar">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `).join('');
    } catch (error) {
        console.error('Error al cargar evaluaciones:', error);
        container.innerHTML = '<div class="content-item"><div class="content-info"><h5>Error al cargar evaluaciones</h5><p>Intenta recargar la p√°gina</p></div></div>';
    }
}

window.deleteEvaluacionFirestore = async function(id) {
    if (!confirm('¬øEst√°s seguro de eliminar esta evaluaci√≥n?')) return;
    try {
        await proxyDeleteCollection('evaluaciones', id);
        await loadEvaluaciones();
        updateStats();
        showAlert('Evaluaci√≥n eliminada exitosamente');
    } catch (error) {
        console.error('Error al eliminar evaluaci√≥n:', error);
        alert('Error al eliminar la evaluaci√≥n');
    }
}

function verEvaluacion(id) {
    showSection('evaluaciones', event);
}

function editarEvaluacion(id) {
    const evaluaciones = JSON.parse(localStorage.getItem('evaluaciones') || '[]');
    const evaluacion = evaluaciones.find(e => e.id === id);
    if (evaluacion) {
        sessionStorage.setItem('evaluacionEditar', JSON.stringify(evaluacion));
        window.location.href = 'crear-evaluacion.html?editar=' + id;
    }
}

function deleteEvaluacion(id) {
    if (!confirm('¬øEst√°s seguro de eliminar esta evaluaci√≥n?')) return;
    let evaluaciones = JSON.parse(localStorage.getItem('evaluaciones') || '[]');
    evaluaciones = evaluaciones.filter(e => e.id !== id);
    localStorage.setItem('evaluaciones', JSON.stringify(evaluaciones));
    loadEvaluaciones();
    updateStats();
    showAlert('Evaluaci√≥n eliminada exitosamente');
}

async function loadMateriales() {
    const container = document.getElementById('materiales-list');
    if (!container) {
        console.error('Container materiales-list no encontrado');
        return;
    }
    
    try {
        if (!db) {
            throw new Error('Firebase no inicializado');
        }
        
        const materiales = await proxyGetCollection('materiales');
        
        console.log('üì¶ Admin - Total materiales en Firestore:', materiales.length);
        console.log('üì¶ Materiales:', materiales);
        
        if (materiales.length === 0) {
            container.innerHTML = '<div class="content-item"><div class="content-info"><h5>No hay materiales publicados</h5><p>Los materiales que subas aparecer√°n aqu√≠</p></div></div>';
            return;
        }
        
        container.innerHTML = materiales.map(material => {
            if (material.tipo === 'pdf') {
                const tamanoMB = (material.tamano / (1024 * 1024)).toFixed(2);
                return `
                    <div class="content-item">
                        <div class="content-info">
                            <h5><i class="fas fa-file-pdf" style="color: #dc2626;"></i> ${material.titulo}</h5>
                            <p>${material.descripcion}</p>
                            <p style="font-size: 13px; color: #64748b;">${material.programa} ‚Ä¢ ${material.fecha} ‚Ä¢ ${tamanoMB} MB ‚Ä¢ <a href="ver-documento.html?id=${material.id}" target="_blank">Ver Documento</a></p>
                        </div>
                        <div class="content-actions">
                            <button class="btn-icon" onclick="window.open('ver-documento.html?id=${material.id}', '_blank')" title="Ver PDF">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn-icon btn-delete" onclick="window.deleteMaterial('${material.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            } else {
                return `
                    <div class="content-item">
                        <div class="content-info">
                            <h5><i class="fas fa-link"></i> ${material.titulo}</h5>
                            <p>${material.descripcion || ''}</p>
                            <p>${material.programa} ‚Ä¢ ${material.fecha} ‚Ä¢ <a href="${material.url}" target="_blank">Ver Material</a></p>
                        </div>
                        <div class="content-actions">
                            <button class="btn-icon btn-delete" onclick="window.deleteMaterial('${material.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            }
        }).join('');
        console.log('‚úÖ Admin - Materiales renderizados desde Firestore');
    } catch (error) {
        console.error('Error al cargar materiales:', error);
        console.error('Detalles del error:', error.message, error.stack);
        container.innerHTML = `<div class="content-item"><div class="content-info"><h5>Error al cargar materiales</h5><p>${error.message || 'Intenta recargar la p√°gina'}</p></div></div>`;
    }
}

async function updateStats() {
    document.getElementById('stat-videos').textContent = JSON.parse(localStorage.getItem('videos') || '[]').length;
    document.getElementById('stat-clases').textContent = JSON.parse(localStorage.getItem('clases') || '[]').length;
    document.getElementById('stat-actividades').textContent = JSON.parse(localStorage.getItem('actividades') || '[]').length;
    
    // Contar materiales desde Firestore
    try {
        try {
            const materialesCount = (await proxyGetCollection('materiales')).length;
            document.getElementById('stat-materiales').textContent = materialesCount;
        } catch (e) { document.getElementById('stat-materiales').textContent = '0'; }
    } catch (error) {
        console.error('Error al contar materiales:', error);
        document.getElementById('stat-materiales').textContent = '0';
    }
    
    // Actualizar contador de cuestionarios
    const statCuestionarios = document.getElementById('stat-cuestionarios');
    if (statCuestionarios) {
        statCuestionarios.textContent = JSON.parse(localStorage.getItem('cuestionarios') || '[]').length;
    }
}

function showAlert(message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = 'alert alert-success';
    alertDiv.innerHTML = `<i class="fas fa-check-circle"></i><div>${message}</div>`;
    alertDiv.style.position = 'fixed';
    alertDiv.style.top = '80px';
    alertDiv.style.right = '20px';
    alertDiv.style.zIndex = '1000';
    alertDiv.style.minWidth = '300px';
    document.body.appendChild(alertDiv);
    setTimeout(() => alertDiv.remove(), 3000);
}

function loadUsuarios() {
    loadUsuariosPendientes();
    loadUsuariosAprobados();
}

async function loadUsuariosPendientes() {
    const container = document.getElementById('usuarios-pendientes');
    try {
        const usuariosSnapshot = await proxyGetCollection('pendingStudents');
        if (!usuariosSnapshot || usuariosSnapshot.length === 0) {
            container.innerHTML = '<div class="content-item"><div class="content-info"><h5>No hay solicitudes pendientes</h5><p>Las nuevas solicitudes aparecer√°n aqu√≠</p></div></div>';
            return;
        }
        const usuarios = usuariosSnapshot.map(data => ({
            id: data.id || data._id || '',
            name: data.name || '',
            email: data.email || '',
            cedula: data.cedula || '',
            telefono: data.telefono || '',
            programa: data.programa || '',
            sede: data.sede || '',
            password: data.password || 'charlotte123'
        }));
        container.innerHTML = usuarios.map(user => `
            <div class="content-item">
                <div class="content-info">
                    <h5>${user.name}</h5>
                    <p>${user.email} ‚Ä¢ ${user.programa} ‚Ä¢ ${user.sede}</p>
                    <p style="font-size:12px;color:#94a3b8;">C√©dula: ${user.cedula} ‚Ä¢ Tel: ${user.telefono}</p>
                </div>
                <div class="content-actions">
                    <button class="btn btn-primary" style="font-size:12px;padding:8px 16px;" onclick="aprobarUsuario('${user.id}','${user.email}','${user.name}','${user.cedula}','${user.telefono}','${user.programa}','${user.sede}','${user.password}')">
                        <i class="fas fa-check"></i> Aprobar
                    </button>
                    <button class="btn-icon btn-delete" onclick="rechazarUsuario('${user.id}')">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
        `).join('');
    } catch (error) {
        console.error('Error:', error);
        container.innerHTML = '<div class="content-item"><div class="content-info"><h5>Error al cargar solicitudes</h5></div></div>';
    }
}

async function loadUsuariosAprobados() {
    const container = document.getElementById('usuarios-aprobados');
    const filterPrograma = document.getElementById('filterPrograma')?.value || '';
    const filterLugar = document.getElementById('filterLugar')?.value || '';
    
    try {
        const approved = await proxyGetCollection('approvedStudents');
        if (!approved || approved.length === 0) {
            container.innerHTML = '<div class="content-item"><div class="content-info"><h5>No hay usuarios aprobados</h5></div></div>';
            return;
        }
        let usuarios = approved.map(data => ({
            id: data.id || '',
            name: data.name || '',
            email: data.email || '',
            password: data.password || 'charlotte123',
            programa: data.programa || '',
            sede: data.sede || '',
            cedula: data.cedula || '',
            telefono: data.telefono || ''
        }));
        // Poblar filtro de lugares
        const lugares = [...new Set(usuarios.map(u => u.sede))].filter(Boolean);
        const filterLugarSelect = document.getElementById('filterLugar');
        if (filterLugarSelect) {
            const currentValue = filterLugarSelect.value;
            filterLugarSelect.innerHTML = '<option value="">Todos los lugares</option>' +
                lugares.map(lugar => `<option value="${lugar}" ${lugar === currentValue ? 'selected' : ''}>${lugar}</option>`).join('');
        }
        // Aplicar filtros
        if (filterPrograma) {
            usuarios = usuarios.filter(u => u.programa === filterPrograma);
        }
        if (filterLugar) {
            usuarios = usuarios.filter(u => u.sede === filterLugar);
        }
        container.innerHTML = usuarios.map(user => `
            <div class="content-item">
                <div class="content-info">
                    <h5>${user.name}</h5>
                    <p style="margin: 4px 0;">
                        <i class="fas fa-envelope"></i> ${user.email}<br>
                        <i class="fas fa-book"></i> ${user.programa} ‚Ä¢ <i class="fas fa-map-marker-alt"></i> ${user.sede}
                    </p>
                    <div style="margin-top: 8px; padding: 8px; background: #f8fafc; border-radius: 6px; display: inline-block;">
                        <i class="fas fa-key"></i> 
                        <strong>Contrase√±a:</strong> 
                        <span id="pass-${user.id}" style="font-family: monospace; background: #e2e8f0; padding: 4px 8px; border-radius: 4px; margin: 0 8px;">
                            ${user.password}
                        </span>
                        <button onclick="copiarContrasena('${user.password}', '${user.name}')" 
                                class="btn-icon" 
                                title="Copiar contrase√±a"
                                style="background: #8B4513; color: white; padding: 4px 8px; border-radius: 4px;">
                            <i class="fas fa-copy"></i>
                        </button>
                        <button onclick="restablecerContrasena('${user.id}', '${user.email}', '${user.name}', '${user.cedula}', '${user.telefono}', '${user.programa}', '${user.sede}')" 
                                class="btn-icon" 
                                title="Restablecer contrase√±a"
                                style="background: #3b82f6; color: white; padding: 4px 8px; border-radius: 4px;">
                            <i class="fas fa-redo"></i>
                        </button>
                    </div>
                </div>
                <div class="content-actions">
                    <button onclick="eliminarUsuarioAprobado('${user.id}', '${user.name}')"
                            class="btn btn-delete" 
                            title="Eliminar estudiante"
                            style="background: #e11d48; color: #fff; font-weight: bold; font-size: 18px; padding: 12px 20px; border-radius: 8px; display: flex; align-items: center; gap: 10px; box-shadow: 0 2px 8px #e11d48a0;">
                        <i class="fas fa-user-slash" style="font-size: 22px;"></i> Eliminar Estudiante
                    </button>
                </div>
            </div>
        `).join('');
    } catch (error) {
        console.error('Error:', error);
    }
}

window.aprobarUsuario = async function(id, email, name, cedula, telefono, programa, sede, password) {
    if (!confirm(`¬øAprobar a ${name}?\n\nNOTA: El estudiante deber√° cambiar su contrase√±a en el primer inicio de sesi√≥n.`)) return;
    try {
        // Crear usuario aprobado en approvedStudents v√≠a proxy y eliminar pending
        await proxyPostCollection('approvedStudents', {
            name: name,
            email: email,
            cedula: cedula,
            telefono: telefono,
            programa: programa,
            sede: sede,
            password: password,
            approved: true,
            needsPasswordReset: true,
            fechaAprobacion: new Date().toISOString()
        });
        // Eliminar de pending
        await proxyDeleteCollection('pendingStudents', id);
        showAlert(`Usuario ${name} aprobado exitosamente.\n\nEl estudiante deber√° crear una nueva contrase√±a en su primer inicio de sesi√≥n.`);
        loadUsuarios();
    } catch (error) {
        console.error('Error:', error);
        alert('Error al aprobar usuario');
    }
}

window.rechazarUsuario = async function(id) {
    if (!confirm('¬øRechazar esta solicitud?')) return;
    try {
        await proxyDeleteCollection('pendingStudents', id);
        showAlert('Solicitud rechazada');
        loadUsuarios();
    } catch (error) {
        console.error('Error:', error);
        alert('Error al rechazar solicitud');
    }
}

window.copiarContrasena = function(password, nombre) {
    navigator.clipboard.writeText(password).then(() => {
        showAlert(`Contrase√±a de ${nombre} copiada al portapapeles`);
    }).catch(err => {
        // Fallback para navegadores que no soportan clipboard API
        const textarea = document.createElement('textarea');
        textarea.value = password;
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand('copy');
        document.body.removeChild(textarea);
        showAlert(`Contrase√±a de ${nombre} copiada al portapapeles`);
    });
}

window.restablecerContrasena = async function(id, email, name, cedula, telefono, programa, sede) {
    const nuevaContrasena = prompt(`Restablecer contrase√±a para ${name}\n\nIngresa la nueva contrase√±a (dejar vac√≠o para usar "charlotte123"):`, 'charlotte123');
    
    if (nuevaContrasena === null) return; // Usuario cancel√≥
    
    const password = nuevaContrasena.trim() || 'charlotte123';
    
    if (!confirm(`¬øCambiar la contrase√±a de ${name} a "${password}"?`)) return;
    
    try {
        await proxyPatchCollection('approvedStudents', id, {
            email: email,
            name: name,
            cedula: cedula,
            telefono: telefono,
            programa: programa,
            sede: sede,
            password: password,
            approved: true,
            lastPasswordReset: new Date().toISOString()
        });
        showAlert(`Contrase√±a restablecida exitosamente para ${name}`);
        loadUsuariosAprobados();
    } catch (error) {
        console.error('Error:', error);
        alert('Error al restablecer contrase√±a');
    }
}

// ===== GESTI√ìN DE CALIFICACIONES =====

async function cargarEstudiantesPorPrograma() {
    const programa = document.getElementById('calificaciones-programa').value;
    const selectEstudiante = document.getElementById('calificaciones-estudiante');
    
    try {
        const approved = await proxyGetCollection('approvedStudents');
        let estudiantes = (approved || []).map(d => ({ name: d.name || '', email: d.email || '', programa: d.programa || '' }));
        if (!estudiantes.length) {
            selectEstudiante.innerHTML = '<option value="">No hay estudiantes</option>';
            return;
        }
        
        if (programa) {
            estudiantes = estudiantes.filter(e => e.programa === programa);
        }
        
        selectEstudiante.innerHTML = '<option value="">Selecciona un estudiante</option>' +
            estudiantes.map(e => `<option value="${e.email}">${e.name} (${e.programa})</option>`).join('');
            
        loadCalificaciones();
    } catch (error) {
        console.error('Error:', error);
    }
}

function loadCalificaciones() {
    const emailEstudiante = document.getElementById('calificaciones-estudiante').value;
    const container = document.getElementById('calificaciones-content');
    
    if (!emailEstudiante) {
        container.innerHTML = '<div style="text-align: center; padding: 60px; color: #64748b;"><i class="fas fa-user-graduate" style="font-size: 48px; margin-bottom: 20px; display: block;"></i><h3>Selecciona un estudiante</h3><p>Elige un estudiante para ver y editar sus calificaciones</p></div>';
        return;
    }
    
    const calificaciones = JSON.parse(localStorage.getItem('calificaciones') || '{}');
    const calificacionesEstudiante = calificaciones[emailEstudiante] || {};
    
    // Obtener actividades, cuestionarios y evaluaciones
    const actividades = JSON.parse(localStorage.getItem('actividades') || '[]');
    const cuestionarios = JSON.parse(localStorage.getItem('cuestionarios') || '[]');
    const evaluaciones = JSON.parse(localStorage.getItem('evaluaciones') || '[]');
    
    let html = '<div style="display: grid; gap: 30px;">';
    
    // ACTIVIDADES
    if (actividades.length > 0) {
        html += `
            <div class="upload-card">
                <h3><i class="fas fa-tasks"></i> Actividades</h3>
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: #f8fafc; border-bottom: 2px solid #e2e8f0;">
                                <th style="padding: 12px; text-align: left;">Actividad</th>
                                <th style="padding: 12px; text-align: left;">Programa</th>
                                <th style="padding: 12px; text-align: center; width: 150px;">Calificaci√≥n</th>
                                <th style="padding: 12px; text-align: center; width: 100px;">Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${actividades.map(act => {
                                const calificacion = calificacionesEstudiante[`actividad_${act.id}`] || { nota: '', observaciones: '' };
                                return `
                                    <tr style="border-bottom: 1px solid #f1f5f9;">
                                        <td style="padding: 12px;">${act.titulo}</td>
                                        <td style="padding: 12px;">${act.programa}</td>
                                        <td style="padding: 12px; text-align: center;">
                                            <input type="number" 
                                                   id="nota_actividad_${act.id}" 
                                                   value="${calificacion.nota}" 
                                                   min="0" max="100" step="0.1"
                                                   placeholder="0-100"
                                                   style="width: 100px; padding: 8px; border: 2px solid #e2e8f0; border-radius: 6px; text-align: center;">
                                        </td>
                                        <td style="padding: 12px; text-align: center;">
                                            <button onclick="guardarCalificacion('${emailEstudiante}', 'actividad', ${act.id})" 
                                                    class="btn-icon" title="Guardar">
                                                <i class="fas fa-save"></i>
                                            </button>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        `;
    }
    
    // CUESTIONARIOS
    if (cuestionarios.length > 0) {
        html += `
            <div class="upload-card">
                <h3><i class="fas fa-file-alt"></i> Cuestionarios</h3>
                <p style="color: #64748b; margin-bottom: 15px;">
                    <i class="fas fa-info-circle"></i> Las calificaciones se registran autom√°ticamente al completar
                </p>
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: #f8fafc; border-bottom: 2px solid #e2e8f0;">
                                <th style="padding: 12px; text-align: left;">Cuestionario</th>
                                <th style="padding: 12px; text-align: left;">Programa</th>
                                <th style="padding: 12px; text-align: center; width: 150px;">Calificaci√≥n</th>
                                <th style="padding: 12px; text-align: center; width: 100px;">Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${cuestionarios.map(cuest => {
                                const calificacion = calificacionesEstudiante[`cuestionario_${cuest.id}`] || { nota: '', auto: true };
                                return `
                                    <tr style="border-bottom: 1px solid #f1f5f9;">
                                        <td style="padding: 12px;">${cuest.titulo}</td>
                                        <td style="padding: 12px;">${cuest.programa}</td>
                                        <td style="padding: 12px; text-align: center;">
                                            ${calificacion.nota ? `
                                                <input type="number" 
                                                       id="nota_cuestionario_${cuest.id}" 
                                                       value="${calificacion.nota}" 
                                                       min="0" max="100" step="0.1"
                                                       style="width: 100px; padding: 8px; border: 2px solid #e2e8f0; border-radius: 6px; text-align: center;">
                                            ` : '<span style="color: #94a3b8;">No realizado</span>'}
                                        </td>
                                        <td style="padding: 12px; text-align: center;">
                                            ${calificacion.nota ? `
                                                <button onclick="guardarCalificacion('${emailEstudiante}', 'cuestionario', ${cuest.id})" 
                                                        class="btn-icon" title="Editar">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                            ` : ''}
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        `;
    }
    
    // EVALUACIONES
    if (evaluaciones.length > 0) {
        html += `
            <div class="upload-card">
                <h3><i class="fas fa-clipboard-check"></i> Evaluaciones</h3>
                <p style="color: #64748b; margin-bottom: 15px;">
                    <i class="fas fa-info-circle"></i> Las calificaciones se registran autom√°ticamente al completar
                </p>
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: #f8fafc; border-bottom: 2px solid #e2e8f0;">
                                <th style="padding: 12px; text-align: left;">Evaluaci√≥n</th>
                                <th style="padding: 12px; text-align: left;">Programa</th>
                                <th style="padding: 12px; text-align: center; width: 150px;">Calificaci√≥n</th>
                                <th style="padding: 12px; text-align: center; width: 100px;">Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${evaluaciones.map(eval => {
                                const calificacion = calificacionesEstudiante[`evaluacion_${eval.id}`] || { nota: '', auto: true };
                                return `
                                    <tr style="border-bottom: 1px solid #f1f5f9;">
                                        <td style="padding: 12px;">${eval.titulo}</td>
                                        <td style="padding: 12px;">${eval.programa}</td>
                                        <td style="padding: 12px; text-align: center;">
                                            ${calificacion.nota ? `
                                                <input type="number" 
                                                       id="nota_evaluacion_${eval.id}" 
                                                       value="${calificacion.nota}" 
                                                       min="0" max="100" step="0.1"
                                                       style="width: 100px; padding: 8px; border: 2px solid #e2e8f0; border-radius: 6px; text-align: center;">
                                            ` : '<span style="color: #94a3b8;">No realizado</span>'}
                                        </td>
                                        <td style="padding: 12px; text-align: center;">
                                            ${calificacion.nota ? `
                                                <button onclick="guardarCalificacion('${emailEstudiante}', 'evaluacion', ${eval.id})" 
                                                        class="btn-icon" title="Editar">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                            ` : ''}
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        `;
    }
    
    html += '</div>';
    container.innerHTML = html;
}

window.guardarCalificacion = function(emailEstudiante, tipo, id) {
    const inputId = `nota_${tipo}_${id}`;
    const nota = document.getElementById(inputId).value;
    
    if (nota === '' || nota < 0 || nota > 100) {
        alert('Ingresa una calificaci√≥n v√°lida entre 0 y 100');
        return;
    }
    
    const calificaciones = JSON.parse(localStorage.getItem('calificaciones') || '{}');
    
    if (!calificaciones[emailEstudiante]) {
        calificaciones[emailEstudiante] = {};
    }
    
    calificaciones[emailEstudiante][`${tipo}_${id}`] = {
        nota: parseFloat(nota),
        fecha: new Date().toLocaleString(),
        tipo: tipo,
        id: id
    };
    
    localStorage.setItem('calificaciones', JSON.stringify(calificaciones));
    showAlert('Calificaci√≥n guardada exitosamente');
}

window.resetCalificaciones = function() {
    document.getElementById('calificaciones-estudiante').value = '';
    document.getElementById('calificaciones-programa').value = '';
    cargarEstudiantesPorPrograma();
}

// Cargar recetas autom√°ticamente
function cargarRecetasIniciales() {
    let materiales = JSON.parse(localStorage.getItem('materiales') || '[]');
    
    // Primero, SIEMPRE eliminar todas las recetas antiguas
    materiales = materiales.filter(m => !m.url || (!m.url.includes('receta') && !m.url.includes('recetario')));
    
    // Agregar solo el √≠ndice de recetas - SOLO PARA PANADER√çA
    const recetas = [
        {
            id: 'recetario-index',
            titulo: '√çndice de Recetas',
            descripcion: 'Navegaci√≥n r√°pida por todas las categor√≠as de recetas',
            url: 'recetario-index.html',
            programa: 'Panader√≠a',
            fecha: new Date().toLocaleDateString()
        }
    ];
    
    materiales = materiales.concat(recetas);
    localStorage.setItem('materiales', JSON.stringify(materiales));
    console.log('‚úÖ Recetas cargadas autom√°ticamente:', recetas.length);
    
    // Recargar materiales si estamos en esa secci√≥n
    if (document.getElementById('materiales') && document.getElementById('materiales').classList.contains('active')) {
        loadMateriales();
    }
}

cargarRecetasIniciales();
updateStats();
    </script>
</body>
</html>

