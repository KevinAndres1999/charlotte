<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Admin | Charlotte</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        .admin-container { min-height: 100vh; background: #f5f5f5; }
        .admin-header { background: var(--accent); color: white; padding: 20px; display: flex; justify-content: space-between; align-items: center; }
        .admin-nav { background: white; padding: 10px 20px; border-bottom: 1px solid #e0e0e0; }
        .nav-btn { background: none; border: none; padding: 10px 20px; cursor: pointer; font-size: 16px; border-radius: 5px; transition: background 0.3s; }
        .nav-btn.active { background: var(--accent); color: white; }
        .admin-main { padding: 20px; }
        .section { display: none; }
        .section.active { display: block; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 20px; }
        .stat-card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); text-align: center; }
        .stat-card h3 { margin: 0 0 10px 0; color: #666; }
        .stat-card p { font-size: 2em; font-weight: bold; color: var(--accent); margin: 0; }
        .students-section { margin-top: 30px; }
        .student-list { background: white; border-radius: 8px; padding: 20px; margin-top: 10px; }
        .student-item { border: 1px solid #e0e0e0; border-radius: 5px; padding: 15px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .student-info h4 { margin: 0 0 5px 0; }
        .student-info p { margin: 2px 0; color: #666; font-size: 14px; }
        .student-actions { display: flex; gap: 10px; }
        .btn-approve, .btn-delete { padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; }
        .btn-approve { background: #28a745; color: white; }
        .btn-delete { background: #dc3545; color: white; }
        .btn-logout { background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; }
    </style>
</head>
<body>
    <div class="admin-container">
        <header class="admin-header">
            <h1>Panel de Administración</h1>
            <button id="logoutBtn" class="btn-logout">Cerrar Sesión</button>
        </header>

        <nav class="admin-nav">
            <button class="nav-btn active" onclick="showSection('dashboard')">Dashboard</button>
            <button class="nav-btn" onclick="showSection('estudiantes')">Aprobar Estudiantes</button>
        </nav>

        <main class="admin-main">
            <section id="dashboard" class="section active">
                <h2>Dashboard</h2>
                <div class="stats-grid">
                    <div class="stat-card"><h3>Videos</h3><p id="stat-videos">0</p></div>
                    <div class="stat-card"><h3>Clases</h3><p id="stat-clases">0</p></div>
                    <div class="stat-card"><h3>Actividades</h3><p id="stat-actividades">0</p></div>
                    <div class="stat-card"><h3>Materiales</h3><p id="stat-materiales">0</p></div>
                </div>
            </section>

            <section id="estudiantes" class="section">
                <h2>Gestión de Estudiantes</h2>
                <p>Aprueba estudiantes registrados y elimina aprobados</p>

                <div class="students-section">
                    <h3>Estudiantes Pendientes de Aprobación</h3>
                    <div id="pending-list" class="student-list"><p>Cargando...</p></div>
                </div>

                <div class="students-section">
                    <h3>Estudiantes Aprobados</h3>
                    <div id="approved-list" class="student-list"><p>Cargando...</p></div>
                </div>
            </section>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js';
        import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js';
        import { getFirestore, collection, query, where, getDocs, doc, updateDoc, deleteDoc } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyCBpoxr8yhAfCVqP00b6DKtMA0JWljlMMA",
            authDomain: "charlotte-babda.firebaseapp.com",
            projectId: "charlotte-babda",
            storageBucket: "charlotte-babda.firebasestorage.app",
            messagingSenderId: "486360806502",
            appId: "1:486360806502:web:d82fb7f351b8fe4587a9a7"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = 'login.html';
                return;
            }

            const userQuery = query(collection(db, 'users'), where('email', '==', user.email));
            const userSnapshot = await getDocs(userQuery);
            if (userSnapshot.empty) {
                alert('Usuario no encontrado');
                signOut(auth);
                return;
            }

            const userData = userSnapshot.docs[0].data();
            if (userData.status !== 'admin') {
                alert('Acceso denegado');
                signOut(auth);
                return;
            }

            loadStudents();
        });

        async function loadStudents() {
            try {
                const pendingQuery = query(collection(db, 'users'), where('status', '==', 'pending'));
                const pendingSnapshot = await getDocs(pendingQuery);
                const pendingList = document.getElementById('pending-list');
                pendingList.innerHTML = pendingSnapshot.empty ? '<p>No hay estudiantes pendientes</p>' : '';

                pendingSnapshot.forEach(docSnap => {
                    const data = docSnap.data();
                    const item = document.createElement('div');
                    item.className = 'student-item';
                    item.innerHTML = `
                        <div class="student-info">
                            <h4>${data.name}</h4>
                            <p>Email: ${data.email}</p>
                            <p>Cédula: ${data.cedula}</p>
                            <p>Programa: ${data.programa}</p>
                            <p>Sede: ${data.sede}</p>
                            <p>Teléfono: ${data.telefono}</p>
                        </div>
                        <div class="student-actions">
                            <button class="btn-approve" onclick="approveStudent('${docSnap.id}')">Aprobar</button>
                        </div>
                    `;
                    pendingList.appendChild(item);
                });

                const approvedQuery = query(collection(db, 'users'), where('status', '==', 'approved'));
                const approvedSnapshot = await getDocs(approvedQuery);
                const approvedList = document.getElementById('approved-list');
                approvedList.innerHTML = approvedSnapshot.empty ? '<p>No hay estudiantes aprobados</p>' : '';

                approvedSnapshot.forEach(docSnap => {
                    const data = docSnap.data();
                    const item = document.createElement('div');
                    item.className = 'student-item';
                    item.innerHTML = `
                        <div class="student-info">
                            <h4>${data.name}</h4>
                            <p>Email: ${data.email}</p>
                            <p>Cédula: ${data.cedula}</p>
                            <p>Programa: ${data.programa}</p>
                            <p>Sede: ${data.sede}</p>
                            <p>Teléfono: ${data.telefono}</p>
                        </div>
                        <div class="student-actions">
                            <button class="btn-delete" onclick="deleteStudent('${docSnap.id}')">Eliminar</button>
                        </div>
                    `;
                    approvedList.appendChild(item);
                });
            } catch (error) {
                console.error('Error:', error);
                alert('Error al cargar estudiantes');
            }
        }

        window.approveStudent = async (id) => {
            if (confirm('¿Aprobar este estudiante?')) {
                try {
                    await updateDoc(doc(db, 'users', id), { status: 'approved' });
                    alert('Estudiante aprobado');
                    loadStudents();
                } catch (error) {
                    console.error('Error:', error);
                    alert('Error al aprobar');
                }
            }
        };

        window.deleteStudent = async (id) => {
            if (confirm('¿Eliminar este estudiante?')) {
                try {
                    await deleteDoc(doc(db, 'users', id));
                    alert('Estudiante eliminado');
                    loadStudents();
                } catch (error) {
                    console.error('Error:', error);
                    alert('Error al eliminar');
                }
            }
        };

        function showSection(section) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(section).classList.add('active');
            document.querySelector(`[onclick="showSection('${section}')"]`).classList.add('active');

            // Si se activa la sección de estudiantes, cargar los datos
            if (section === 'estudiantes') {
                loadStudents();
            }
        }

        // Exponer función globalmente
        window.showSection = showSection;

        document.getElementById('logoutBtn').addEventListener('click', () => {
            signOut(auth).then(() => window.location.href = 'index.html');
        });
    </script>
</body>
</html>
